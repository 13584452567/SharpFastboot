name: Sync AOSP Code

on:
  workflow_dispatch:

jobs:
  sync_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Create working directory
        run: |
          mkdir -p aosp_code
          mkdir -p aosp_code/adb
          mkdir -p aosp_code/fastboot
          mkdir -p aosp_code/external/e2fsprogs
          mkdir -p aosp_code/external/f2fs-tools
          mkdir -p aosp_code/external/avb
          mkdir -p aosp_code/system/extras/liblp
          mkdir -p aosp_code/system/tools/mkbootimg

      - name: Pull adb code
        run: |
          git clone --depth 1 https://android.googlesource.com/platform/packages/modules/adb aosp_adb_temp
          if [ -d "aosp_adb_temp" ]; then
            cp -r aosp_adb_temp/* aosp_code/adb/
            rm -rf aosp_adb_temp
          else
             git clone --depth 1 https://android.googlesource.com/platform/system/core aosp_core_temp
             cp -r aosp_core_temp/adb/* aosp_code/adb/
             rm -rf aosp_core_temp
          fi

      - name: Pull fastboot code
        run: |
          git clone --depth 1 https://android.googlesource.com/platform/system/core aosp_core_temp
          cp -r aosp_core_temp/fastboot/* aosp_code/fastboot/
          rm -rf aosp_core_temp

      - name: Pull e2fsprogs code
        run: |
          git clone --depth 1 https://android.googlesource.com/platform/external/e2fsprogs aosp_e2fsprogs_temp
          cp -r aosp_e2fsprogs_temp/* aosp_code/external/e2fsprogs/
          rm -rf aosp_e2fsprogs_temp

      - name: Pull f2fs-tools code
        run: |
          git clone --depth 1 https://android.googlesource.com/platform/external/f2fs-tools aosp_f2fs_temp
          cp -r aosp_f2fs_temp/* aosp_code/external/f2fs-tools/
          rm -rf aosp_f2fs_temp
      
      - name: Pull AVB code
        run: |
          git clone --depth 1 https://android.googlesource.com/platform/external/avb aosp_avb_temp
          cp -r aosp_avb_temp/* aosp_code/external/avb/
          rm -rf aosp_avb_temp

      - name: Pull liblp code
        run: |
          git clone --depth 1 https://android.googlesource.com/platform/system/extras aosp_extras_temp
          if [ -d "aosp_extras_temp/liblp" ]; then
            cp -r aosp_extras_temp/liblp/* aosp_code/system/extras/liblp/
          else
            # Fallback searching in system/core if it moved there
            git clone --depth 1 https://android.googlesource.com/platform/system/core aosp_core_temp_lp
            if [ -d "aosp_core_temp_lp/liblp" ]; then
               cp -r aosp_core_temp_lp/liblp/* aosp_code/system/extras/liblp/
            fi
            rm -rf aosp_core_temp_lp
          fi
          rm -rf aosp_extras_temp

      - name: Pull mkbootimg code
        run: |
          git clone --depth 1 https://android.googlesource.com/platform/system/tools/mkbootimg aosp_mkbootimg_temp
          cp -r aosp_mkbootimg_temp/* aosp_code/system/tools/mkbootimg/
          rm -rf aosp_mkbootimg_temp

      - name: Create Archive
        run: |
          VERSION=$(date +'%Y%m%d')
          zip -r "aosp-code-all-${VERSION}.zip" aosp_code/
          echo "ARCHIVE_NAME=aosp-code-all-${VERSION}.zip" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ${{ env.ARCHIVE_NAME }}
          path: ${{ env.ARCHIVE_NAME }}
          retention-days: 7
